<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebClip iOS</title>
    <style>
        /* ===== Couleurs & typographie ===== */
        :root {
            --bg-color: #2c2c2c;
            --text-color: #f0f0f0;
            --input-bg: #3a3a3a;
            --input-border: #555;
            --placeholder: #bbb;
            --btn-bg: #1f6391;
            --btn-bg-hover: #16607a;
            --alert-bg: #4f4e50;
            --alert-text: #ffdd57;
            --modal-bg: rgba(0, 0, 0, 0.6);
            --modal-content-bg: #3a3a3a;
            --modal-text: #f0f0f0;
            --tooltip-bg: #444;
            --tooltip-text: #f0f0f0;
        }

        body {
            margin: 0;
            padding: 1rem;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.4;
        }

        h1 {
            text-align: center;
            color: var(--text-color);
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        /* ===== Alerte "Ouvre dans Safari" ===== */
        .alert {
            background: var(--alert-bg);
            border-radius: 4px;
            padding: 0.8rem 1rem;
            margin-bottom: 1rem;
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: var(--alert-text);
            font-size: 0.95rem;
        }

        .alert svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        /* ===== Formulaire ===== */
        form {
            width: 100%;
            max-width: 100%;
            margin: 0 auto 2rem;
            background: var(--input-bg);
            padding: 1rem;
            border-radius: 8px;
        }

        form label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.4rem;
            font-size: 1rem;
        }

        form input[type="text"],
        form textarea {
            width: 100%;
            background: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--input-border);
            border-radius: 4px;
            padding: 0.6rem;
            margin-bottom: 1.2rem;
            font-size: 1rem;
        }

        form input::placeholder,
        form textarea::placeholder {
            color: var(--placeholder);
        }

        form input[type="file"] {
            color: var(--text-color);
            margin-bottom: 1.2rem;
        }

        form button {
            width: 100%;
            padding: 0.8rem;
            background: var(--btn-bg);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 1.1rem;
            cursor: pointer;
            margin-top: 0.5rem;
        }

        form button:hover {
            background: var(--btn-bg-hover);
        }

        /* ===== Switches ===== */
        .switch-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.2rem;
        }

        .switch-label {
            font-weight: 600;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
            color: var(--text-color);
        }

        .switch {
            position: relative;
            width: 44px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #555;
            border-radius: 34px;
            transition: 0.2s;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            border-radius: 50%;
            transition: 0.2s;
        }

        input:checked+.slider {
            background-color: #4caf50;
        }

        input:checked+.slider:before {
            transform: translateX(20px);
        }

        /* ===== Tooltip ‚Äúùñé‚Äù ===== */
        .tooltip-wrapper {
            position: relative;
            display: inline-block;
            margin-right: 0.25rem;
        }

        .tooltip-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            background: #3498db;
            color: #fff;
            border-radius: 50%;
            font-size: 12px;
            line-height: 18px;
            text-align: center;
            cursor: default;
        }

        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text);
            text-align: left;
            padding: 0.4rem;
            border-radius: 4px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.2s;
            font-size: 0.85rem;
            line-height: 1.2;
        }

        .tooltip-wrapper:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }

        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--tooltip-bg) transparent transparent transparent;
        }

        /* ===== Modal ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: var(--modal-bg);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--modal-content-bg);
            padding: 1rem;
            border-radius: 6px;
            max-width: 300px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
        }

        .modal-content p {
            margin-bottom: 1rem;
            font-size: 0.95rem;
            color: var(--modal-text);
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            gap: 0.5rem;
        }

        .modal-buttons button {
            flex: 1;
            padding: 0.6rem 0;
            border: none;
            border-radius: 4px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: background 0.2s ease;
            color: #fff;
        }

        .btn-cancel {
            background: #e74c3c;
        }

        .btn-cancel:hover {
            background: #c0392b;
        }

        .btn-continue {
            background: #27ae60;
        }

        .btn-continue:hover {
            background: #1e8449;
        }

        /* ===== Responsive ===== */
        @media (max-width: 480px) {
            h1 {
                font-size: 1.3rem;
            }

            form {
                padding: 0.8rem;
            }

            .tooltip-text {
                width: 160px;
            }
        }
    </style>
</head>

<body>
    <h1>üì± WebClip iOS</h1>

    <!-- Alerte si pas sur Safari iOS -->
    <div id="safari-alert" class="alert">
        <svg viewBox="0 0 512 512">
            <path fill="currentColor"
                d="M256 48C141.1 48 48 141.1 48 256s93.1 208 208 208 208-93.1 208-208S370.9 48 256 48zM246.2 362h19.6v19.6h-19.6V362zM246.2 102h19.6v202h-19.6V102z" />
        </svg>
        Pour installer un profil de fa√ßon optimale sur votre iPhone/iPad, ouvrez cette page sur votre navigateur
        <strong>Apple Safari</strong> üì≤
    </div>

    <!-- ===== Formulaire ===== -->
    <form id="webclipForm" novalidate>
        <!-- 1. Nom de l‚Äôapplication -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Nom qui appara√Ætra sous l‚Äôic√¥ne sur l‚Äô√©cran d‚Äôaccueil iOS.
                Sert aussi pour : PayloadIdentifier, PayloadDisplayName, Label.
            </span>
        </span>
        <label for="appName">
            Nom de l‚Äôapplication üìõ
        </label>
        <input type="text" id="appName" placeholder="Ex. Mon Super App" required />

        <!-- 2. Description -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Texte descriptif visible lors de l‚Äôinstallation du profil.
                Si vide, on prendra le nom comme description.
            </span>
        </span>
        <label for="appDesc">
            Description de l‚Äôapplication üìù
        </label>
        <textarea id="appDesc" rows="2" placeholder="Petite description" required></textarea>

        <!-- 3. URL cible -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Adresse du site/web app √† ouvrir en plein √©cran.
                Doit commencer par <code>https://</code>.
            </span>
        </span>
        <label for="appURL">
            URL cible üîó
        </label>
        <input type="text" id="appURL" placeholder="https://exemple.com" required />

        <!-- 4. Ic√¥ne (Base64) -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Image PNG/JPG convertie automatiquement en Base64.
                (Id√©al : carr√© 144√ó144 px)
            </span>
        </span>
        <label for="iconFile">
            Ic√¥ne de l‚Äôapplication üñºÔ∏è
        </label>
        <input type="file" id="iconFile" accept="image/png, image/jpeg" required />
        <small
            style="display:block; margin-top:-0.8rem; margin-bottom:0.8rem; color:var(--placeholder); font-size:0.85rem;">
            S√©lectionne un fichier, il sera encod√© en Base64.
        </small>

        <!-- 5. IsRemovable (Switch) -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Si ON (par d√©faut), l‚Äôutilisateur pourra supprimer l‚Äôic√¥ne.
                Si OFF, l‚Äôic√¥ne restera fix√©e sur l‚Äô√©cran (confirm avec popup).
            </span>
        </span>
        <div class="switch-container">
            <label class="switch-label" for="isRemovable">
                Ic√¥ne retirable ?
            </label>
            <label class="switch">
                <input type="checkbox" id="isRemovable" checked>
                <span class="slider"></span>
            </label>
        </div>

        <!-- 6. IgnoreManifestScope (Switch) -->
        <span class="tooltip-wrapper" onclick="event.stopPropagation()">
            <span class="tooltip-icon">ùñé</span>
            <span class="tooltip-text">
                Si ON (par d√©faut), iOS n‚Äôessaie pas de charger manifest.appcache.
                Si OFF, iOS v√©rifie le manifest avant d‚Äôafficher le WebClip.
            </span>
        </span>
        <div class="switch-container">
            <label class="switch-label" for="ignoreScope">

                Ignorer le manifest ?
            </label>
            <label class="switch">
                <input type="checkbox" id="ignoreScope" checked>
                <span class="slider"></span>
            </label>
        </div>

        <button type="submit">‚úÖ G√©n√©rer et Installer</button>
    </form>

    <!-- ===== Modal pour IsRemovable OFF ===== -->
    <div id="modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <p style="color: var(--modal-text);">
                ‚ö†Ô∏è Si tu d√©sactives <strong>IsRemovable</strong>, l‚Äôic√¥ne ne pourra plus √™tre retir√©e
                de l‚Äô√©cran d‚Äôaccueil. Veux-tu continuer ?
            </p>
            <div class="modal-buttons">
                <button id="btn-cancel" class="btn-cancel">‚ùå Annuler</button>
                <button id="btn-continue" class="btn-continue">‚úÖ Continuer</button>
            </div>
        </div>
    </div>

    <!-- ===== Modal d‚Äôalerte g√©n√©rique ===== -->
    <div id="modal-alert" class="modal-overlay">
        <div class="modal-content">
            <p id="modal-alert-message" style="color: var(--modal-text);"></p>
            <div class="modal-buttons" style="justify-content: center;">
                <button id="btn-alert-ok" class="btn-continue" style="max-width: 120px;">OK</button>
            </div>
        </div>
    </div>

    <script>
        /* ===== D√©tection Safari iOS ===== */
        function isIosSafari() {
            const ua = window.navigator.userAgent;
            const isIOS = /iP(ad|hone|od)/.test(ua);
            const isSafari = /Safari/.test(ua) && !/CriOS|FxiOS|OPiOS|EdgiOS/.test(ua);
            return isIOS && isSafari;
        }
        document.addEventListener('DOMContentLoaded', () => {
            if (!isIosSafari()) {
                const alertDiv = document.getElementById('safari-alert');
                alertDiv.style.display = 'flex';
            }
        });

        /* ===== Conversion Ic√¥ne en Base64 ===== */
        let iconBase64String = "";
        const iconInput = document.getElementById('iconFile');
        iconInput.addEventListener('change', () => {
            const file = iconInput.files[0];
            if (!file) {
                iconBase64String = "";
                return;
            }
            const reader = new FileReader();
            reader.onload = function (e) {
                const dataUrl = e.target.result;
                const commaIndex = dataUrl.indexOf(',');
                iconBase64String = commaIndex >= 0 ? dataUrl.slice(commaIndex + 1) : dataUrl;
            };
            reader.readAsDataURL(file);
        });

        /* ===== Modal ‚ÄúIsRemovable OFF‚Äù ===== */
        const isRemovableCheckbox = document.getElementById('isRemovable');
        const modalOverlay = document.getElementById('modal-overlay');
        const btnCancel = document.getElementById('btn-cancel');
        const btnContinue = document.getElementById('btn-continue');
        let previousRemovableState = isRemovableCheckbox.checked;

        isRemovableCheckbox.addEventListener('change', () => {
            if (previousRemovableState === true && !isRemovableCheckbox.checked) {
                modalOverlay.style.display = 'flex';
            }
            previousRemovableState = isRemovableCheckbox.checked;
        });
        btnCancel.addEventListener('click', () => {
            isRemovableCheckbox.checked = true;
            previousRemovableState = true;
            modalOverlay.style.display = 'none';
        });
        btnContinue.addEventListener('click', () => {
            previousRemovableState = false;
            modalOverlay.style.display = 'none';
        });

        /* ===== G√©n√©ration d‚ÄôUUID ===== */
        function generateUUID() {
            if (crypto && crypto.randomUUID) {
                return crypto.randomUUID().toUpperCase();
            }
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            }).toUpperCase();
        }

        /* ===== Construction du XML (.mobileconfig) ===== */
        function buildMobileConfig({ name, desc, url, iconData, isRemovable, ignoreScope, uuidProfile, uuidPayload }) {
            const consentText = `
  <key>ConsentText</key>
  <dict>
    <key>default</key>
    <string>
      This configuration profile will install a Web Clip on your device‚Äôs home screen. 
      The Web Clip acts as a shortcut to open a specific website in full-screen mode, 
      removing the browser interface to offer an app-like experience. It is designed 
      to simplify access and provide an immersive, standalone view of the site. 

      To proceed tap 'Install' and enter your device's passcode when prompted.

      In case you face any issue or you have any questions or worries about the WebClip, feel free to write me an email and I will gladly respond to you as soon as possible.
      My email : tokyoboy.vs@icloud.com
    </string>
  </dict>`;

            const iconBlock = iconData
                ? `<key>Icon</key>
     <data>${iconData}</data>`
                : `<key>Icon</key>
     <data></data>`;

            return `<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" 
  "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
${consentText}
  <key>PayloadContent</key>
  <array>
    <dict>
      <key>FullScreen</key>
      <true/>
      <key>IgnoreManifestScope</key>
      <${ignoreScope}/>
      ${iconBlock}
      <key>IsRemovable</key>
      <${isRemovable}/>
      <key>Label</key>
      <string>${name}</string>
      <key>PayloadDescription</key>
      <string>${desc || name}</string>
      <key>PayloadDisplayName</key>
      <string>Web Clip (${name})</string>
      <key>PayloadIdentifier</key>
      <string>${name.replace(/\s+/g, "_")}</string>
      <key>PayloadOrganization</key>
      <string>TokyoBoyVS</string>
      <key>PayloadType</key>
      <string>com.apple.webClip.managed</string>
      <key>PayloadUUID</key>
      <string>${uuidPayload}</string>
      <key>PayloadVersion</key>
      <integer>1</integer>
      <key>Precomposed</key>
      <false/>
      <key>URL</key>
      <string>${url}</string>
    </dict>
  </array>
  <key>PayloadDescription</key>
  <string>${desc || name}</string>
  <key>PayloadDisplayName</key>
  <string>${name}</string>
  <key>PayloadIdentifier</key>
  <string>${name.replace(/\s+/g, "_")}</string>
  <key>PayloadOrganization</key>
  <string>TokyoBoyVS</string>
  <key>PayloadRemovalDisallowed</key>
  <false/>
  <key>PayloadType</key>
  <string>Configuration</string>
  <key>PayloadUUID</key>
  <string>${uuidProfile}</string>
  <key>PayloadVersion</key>
  <integer>1</integer>
</dict>
</plist>`;
        }

        /* ===== Soumission du formulaire ===== */
        document.getElementById('webclipForm').addEventListener('submit', (e) => {
            e.preventDefault();

            const name = document.getElementById('appName').value.trim();
            let url = document.getElementById('appURL').value.trim();
            const desc = document.getElementById('appDesc').value.trim();
            const isRemovable = document.getElementById('isRemovable').checked ? "true" : "false";
            const ignoreScope = document.getElementById('ignoreScope').checked ? "true" : "false";

            if (!name) {
                showModalAlert('‚ùå Le nom de l‚Äôapplication est requis.');
                return;
            }
            try {
                url = new URL(url).href;
            } catch {
                showModalAlert('‚ùå L‚ÄôURL n‚Äôest pas valide ! Doit commencer par https://');
                return;
            }

            const uuidPayload = generateUUID();
            const uuidProfile = generateUUID();

            const xmlContent = buildMobileConfig({
                name,
                desc,
                url,
                iconData: iconBase64String,
                isRemovable,
                ignoreScope,
                uuidProfile,
                uuidPayload
            });

            const blob = new Blob([xmlContent], {
                type: 'application/x-apple-aspen-config'
            });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `${name.replace(/\s+/g, "_") || 'webclip'}.mobileconfig`;
            link.target = '_blank';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        /* ===== Modal d‚Äôalerte g√©n√©rique ===== */
        const modalAlert = document.getElementById('modal-alert');
        const modalAlertMsg = document.getElementById('modal-alert-message');
        const btnAlertOk = document.getElementById('btn-alert-ok');
        function showModalAlert(message) {
            modalAlertMsg.textContent = message;
            modalAlert.style.display = 'flex';
        }
        btnAlertOk.addEventListener('click', () => {
            modalAlert.style.display = 'none';
        });
    </script>
</body>

</html>

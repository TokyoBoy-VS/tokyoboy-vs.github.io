<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>RDO ‚Ä¢ Progression Animaux L√©gendaires</title>
<style>
  /* THEME */
  :root{
    --radius-card:16px; --radius-input:12px; --radius-tick:12px; --radius-thumb:12px;
    --fs-base:16px; --gap-page:16px; --gap-card:10px; --gap-grid:24px;
    --touch:48px;
  }
  :root[data-theme="dark"]{
    --bg:#0c0f15; --card:#131926; --ink:#eef1f5; --muted:#9aa4b2; --line:#263142;
    --chip:#0f1625; --chipLine:#2a3750;
    --btn:#0f1522; --btn-line:#2c3a55; --btn-ink:#eef1f5; --btn-active:#182238;
    --prog-start:#67e8f9; --prog-end:#a78bfa;
    --tick-bg:#0e1912; --tick-line:#2d5a3a; --tick-on-ring:rgba(34,197,94,.35); --tick-on-line:#16a34a;
    --cat-ink:#cdd5e3;
  }
  :root[data-theme="light"]{
    --bg:#f5f7fb; --card:#ffffff; --ink:#0e0f12; --muted:#606b7a; --line:#dbe1ea;
    --chip:#eef2f8; --chipLine:#d5dde8;
    --btn:#f3f6fb; --btn-line:#cfd7e5; --btn-ink:#0e0f12; --btn-active:#e8eef8;
    --prog-start:#06b6d4; --prog-end:#8b5cf6;
    --tick-bg:#eef8f1; --tick-line:#b9e3c6; --tick-on-ring:rgba(22,163,74,.25); --tick-on-line:#16a34a;
    --cat-ink:#334155;
  }

  /* BASE */
  *{box-sizing:border-box}
  html,body{height:100%}
  html{touch-action:manipulation}
  body{
    margin:0; background:var(--bg); color:var(--ink);
    font-family: Inter, system-ui, -apple-system, Segoe UI, Arial, sans-serif;
    font-size:var(--fs-base); -webkit-tap-highlight-color:transparent;
  }
  header{
    position:sticky; top:0; z-index:50;
    background:color-mix(in srgb, var(--bg) 92%, transparent);
    backdrop-filter: blur(8px);
    border-bottom:1px solid var(--line);
  }
  .wrap{max-width:980px;margin:0 auto;padding:14px}
  h1{margin:0 0 6px;font-size:clamp(18px,4.5vw,24px)}
  .sub{color:var(--muted);font-size:13px}

  /* HEADER COMPACT */
  .controls{display:grid;gap:8px;margin-top:12px}
  .controls--compact{grid-template-columns:1fr auto auto}
  .input, select, button{
    height:var(--touch); border-radius:var(--radius-input);
    border:1px solid var(--line); background:var(--btn); color:var(--btn-ink);
  }
  .input, select{padding:0 12px}
  button{padding:0 12px; cursor:pointer}
  button:active{transform:scale(.98)}
  .btn-outline{
    background:transparent; color:var(--btn-ink);
    border:1px solid var(--btn-line); border-radius:var(--radius-input);
  }
  .bar{height:10px;border-radius:999px;background:color-mix(in srgb, var(--bg) 75%, #000 0%);border:1px solid var(--line);overflow:hidden}
  .bar--thin{ height:8px; border-radius:999px; margin:10px 0 4px; }
  .fill{height:100%;width:0}
  .ok{background:linear-gradient(90deg,var(--prog-start),var(--prog-end))}
  .warn{background:linear-gradient(90deg,#f43f5e,#f59e0b)}
  .stats{display:flex;gap:10px;align-items:center}
  .stats--mini .small{ margin-left:0; }
  .pct{min-width:46px;text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
  .small{color:var(--muted);font-size:12px;margin-left:auto}

  /* PANEL REPLIABLE */
  #filtersPanel{
    margin-top:10px; border:1px solid var(--line); border-radius:var(--radius-card); padding:8px 10px;
    background:var(--card);
  }
  #filtersPanel > summary{
    cursor:pointer; list-style:none; font-weight:600; color:var(--ink);
    display:flex; align-items:center; gap:8px;
  }
  #filtersPanel > summary::after{ content:"‚ñæ"; opacity:.75; font-size:12px; }
  #filtersPanel[open] > summary{ margin-bottom:10px; }
  #filtersPanel > summary::-webkit-details-marker{ display:none; }
  .grid-filters{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin:10px 0; }
  @media (min-width:780px){ .grid-filters{ grid-template-columns:180px 180px auto auto auto auto; } }

  .legend{ display:flex; flex-wrap:wrap; gap:8px; }
  .chip{
    padding:8px 10px; border:1px solid var(--chipLine); border-radius:999px;
    background:var(--chip); color:var(--muted);
  }
  .chip:active{ transform:scale(.98); }
  .hint{ color:var(--muted); font-size:12px; margin-top:8px }

  /* GRID & SECTION CARDS */
  main{padding:var(--gap-page);max-width:980px;margin:0 auto}
  .grid{ display:grid; gap:var(--gap-grid); }

  .section-card{
    border:1px solid var(--line); border-radius:calc(var(--radius-card) + 2px);
    background:var(--card); overflow:hidden;
  }
  .section-card > summary{
    display:flex; align-items:center; gap:12px;
    cursor:pointer; padding:14px 14px; list-style:none; user-select:none;
    font-weight:800; color:var(--cat-ink);
  }
  .section-card > summary::-webkit-details-marker{ display:none; }
  .section-card > summary .cat-dot{
    width:10px;height:10px;border-radius:999px;background:var(--prog-start);display:inline-block;
  }
  .cat-meta{
    display:flex; align-items:center; gap:8px; margin-left:auto; min-width:140px;
  }
  .cat-pct{ color:var(--muted); font-size:13px; width:44px; text-align:right; font-variant-numeric:tabular-nums; }
  .cat-bar{ flex:1; height:6px; border-radius:999px; border:1px solid var(--line); background:color-mix(in srgb, var(--bg) 75%, #000 0%); overflow:hidden }
  .cat-fill{ height:100%; width:0 }
  .cat-fill.ok{ background:linear-gradient(90deg,var(--prog-start),var(--prog-end)) }
  .cat-fill.warn{ background:linear-gradient(90deg,#f43f5e,#f59e0b) }

  .section-card > .section-body{
    padding: 12px 14px 16px;
    border-top:1px solid var(--line);
  }
  .section-card[open] > summary{ border-bottom:1px solid var(--line); }

  .section-body .cards-grid{
    display:grid; gap:var(--gap-grid);
  }
  @media (min-width:640px){
    .section-body .cards-grid{ grid-template-columns:repeat(auto-fit,minmax(350px,1fr)) }
  }

  /* ANIMAL CARD (layout v2: thumb left, info right, meta+checklist full width) */
  .card{
    display:grid; gap:var(--gap-card);
    background:var(--card); border:1px solid var(--line); border-radius:var(--radius-card);
    padding:14px;
  }
  .top{ display:grid; grid-template-columns:84px 1fr; gap:12px; align-items:center; }
  @media (min-width:640px){ .top{ grid-template-columns:110px 1fr; } }
  .thumb{
    width:84px; height:84px; border-radius:var(--radius-thumb);
    border:1px solid var(--line); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));
    overflow:hidden;
  }
  @media (min-width:640px){ .thumb{ width:110px; height:110px; } }
  .thumb img{ width:100%; height:100%; object-fit:contain; display:block; }
  .info .name{font-weight:800;font-size:16px;line-height:1.2;margin-bottom:2px}
  @media (min-width:640px){ .info .name{font-size:18px} }
  .info .loc{color:var(--ink);opacity:.9}
  .info .cond{color:var(--muted);font-style:italic}

  .rowbar{display:flex;align-items:center;gap:10px;margin-top:2px}
  .checklist{display:flex;flex-wrap:wrap;gap:10px;margin-top:6px}
  .tick{
    width:var(--touch); height:var(--touch);
    border-radius:var(--radius-tick);
    border:1px solid var(--tick-line); background:var(--tick-bg);
    display:inline-flex; align-items:center; justify-content:center;
    font-size:20px; cursor:pointer; user-select:none;
    box-shadow:0 1px 0 rgba(0,0,0,.25) inset; transition:transform .06s ease, box-shadow .15s ease;
    min-width:44px; min-height:44px;
  }
  .tick[data-on="true"]{box-shadow:0 0 0 3px var(--tick-on-ring) inset, 0 0 0 1px var(--tick-on-line)}
  .tick:active{transform:scale(.98)}
  .pct{min-width:46px;text-align:right;color:var(--muted);font-variant-numeric:tabular-nums}
  .count{color:var(--muted);font-size:12px;margin-left:auto}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <h1>üìú Progression Animaux L√©gendaires RDO</h1>
    <div class="sub">Cartes optimis√©es iPhone ‚Ä¢ Sauvegarde locale ‚Ä¢ Th√®me clair/sombre</div>

    <!-- Barre sticky compacte -->
    <div class="controls controls--compact">
      <input id="q" class="input" type="search" placeholder="Rechercher (animal, lieu, condition)‚Ä¶" inputmode="search"/>
      <button id="filtersToggle" class="btn-outline" aria-controls="filtersPanel">üîé Filtres</button>
      <button id="themeBtn" title="Basculer clair/sombre">üåì</button>
    </div>

    <!-- Barre de progression globale FINE -->
    <div class="bar bar--thin" aria-label="Progression globale">
      <div class="fill warn" id="gFill"></div>
    </div>
    <div class="stats stats--mini">
      <strong>Global</strong>
      <div class="pct" id="gPct">0%</div>
      <div class="small" id="gCount">0 / 0 actions</div>
    </div>

    <!-- Panneau repliable : filtres + outils + l√©gende -->
    <details id="filtersPanel">
      <summary>Filtres & Outils</summary>

      <div class="grid-filters">
        <select id="fMission" title="Filtre mission">
          <option value="">Mission ‚Äî Tous</option>
          <option value="mission">Mission uniquement</option>
          <option value="libre">Hors mission</option>
        </select>
        <select id="fTag" title="Filtre condition">
          <option value="">Condition ‚Äî Toutes</option>
          <option value="aube">Aube</option>
          <option value="crepuscule">Cr√©puscule</option>
          <option value="nuit">Nuit</option>
          <option value="journee">Journ√©e</option>
          <option value="pluie">Pluie</option>
          <option value="brouillard">Brouillard</option>
          <option value="orage">Orage</option>
          <option value="clair">Temps clair</option>
        </select>
        <button id="checkAll">Cocher visibles</button>
        <button id="uncheckAll">D√©cocher visibles</button>
        <button id="resetAll">R√©initialiser</button>
        <button id="clearLS" title="Effacer le stockage local">üóëÔ∏è Effacer stockage</button>
      </div>

      <div class="legend">
        <button class="chip" data-action-chip="piste">üêæ Pist√©</button>
        <button class="chip" data-action-chip="tue">ü™¶ Tu√©s</button>
        <button class="chip" data-action-chip="depece">üî™ D√©pec√©s</button>
        <button class="chip" data-action-chip="etudie">üîé √âtudi√©</button>
        <button class="chip" data-action-chip="anesthesie">üíâ Anesth√©si√©</button>
        <button class="chip" data-action-chip="echantillon">üß¨ √âchantillon</button>
        <button class="chip" data-action-chip="photo">üì∏ Photo</button>
      </div>
      <div class="hint">Astuce : tap sur un chip = (d√©)cocher cette action pour toutes les cartes visibles.</div>
    </details>
  </div>
</header>

<main>
  <section id="groups" class="grid"></section>
</main>

<script>
/* ===== Keys prefix ===== */
const PREFIX = "TBVS_RDO_";
const KEYS = {
  theme: PREFIX + "theme",
  filtersOpen: PREFIX + "filters_open",
  sectionOpen: (cat) => PREFIX + "section_open_" + cat,
  action: (idx, key) => PREFIX + idx + ":" + key
};

/* ===== Actions ===== */
const ACTIONS = [
  { key:"piste", icon:"üêæ" },
  { key:"tue", icon:"ü™¶" },
  { key:"depece", icon:"üî™" },
  { key:"etudie", icon:"üîé" },
  { key:"anesthesie", icon:"üíâ" },
  { key:"echantillon", icon:"üß¨" },
  { key:"photo", icon:"üì∏" }
];

/* ===== Base data ===== */
const BASE = [
  { id:"ours_esprit_dore", name:"Ours esprit dor√©", location:"Big Valley", condition:"Mission" },
  { id:"ours_owiza", name:"Ours Owiza", location:"Rivi√®re Dakota", condition:"√Ä l‚Äôaube ou au cr√©puscule" },
  { id:"ours_esprit_cotier", name:"Ours esprit c√¥tier", location:"Rivi√®re Little Creek", condition:"En journ√©e" },
  { id:"castor_tenebreux", name:"Castor tenebreux", location:"Roanoke Ridge", condition:"Mission" },
  { id:"castor_zizi", name:"Castor Zizi", location:"Ownjila", condition:"√Ä l‚Äôaube ou au cr√©puscule" },
  { id:"castor_lunaire", name:"Castor lunaire", location:"Sud de Elysian Pool, √† l‚Äôest de Van Horn", condition:"√Ä l‚Äôaube ou au cr√©puscule sous la pluie" },
  { id:"bison_tatanka", name:"Bison Tatanka", location:"Champs p√©trolif√®res de Heartland", condition:"Sous la pluie en journ√©e" },
  { id:"bison_winyan", name:"Bison Winyan", location:"Nord du lac Isabella", condition:"De nuit par temps clair" },
  { id:"bison_payta", name:"Bison Payta", location:"Little Creek", condition:"Mission" },
  { id:"sanglier_cogi", name:"Sanglier Cogi", location:"Marais Bluewater", condition:"√Ä l‚Äôaube par temps clair" },
  { id:"sanglier_wakpa", name:"Sanglier Wakpa", location:"Marais Stillwater", condition:"Sous la pluie en journ√©e" },
  { id:"sanglier_icahi", name:"Sanglier Icahi", location:"Est de New Austin", condition:"Mission" },
  { id:"cerf_pataugeur", name:"Cerf pataugeur", location:"Lac Flat Iron", condition:"En journ√©e par temps clair" },
  { id:"cerf_des_neiges", name:"Cerf des neiges", location:"Bassin Aurora", condition:"√Ä l‚Äôaube par temps clair" },
  { id:"cerf_ombre", name:"Cerf ombr√©", location:"Annesburg", condition:"Mission" },
  { id:"couguar_iguga", name:"Couguar Iguga", location:"Sud-est des Grandes Plaines (au sud de Blackwater)", condition:"Au cr√©puscule par temps orageux" },
  { id:"couguar_maza", name:"Couguar Maza", location:"Mer de Coronado", condition:"√Ä l‚Äôaube par temps clair" },
  { id:"couguar_sapa", name:"Couguar Sapa", location:"Nord-est de New Austin", condition:"Mission" },
  { id:"coyote_rubigineux", name:"Coyote rubigineux", location:"Pike‚Äôs Basin", condition:"Au cr√©puscule" },
  { id:"coyote_ebene", name:"Coyote d‚Äô√©b√®ne", location:"Sud-est de Strawberry", condition:"√Ä l‚Äôaube et en journ√©e par temps clair" },
  { id:"coyote_laiteux", name:"Coyote laiteux", location:"Blackwater", condition:"Mission" },
  { id:"wapiti_katata", name:"Wapiti Katata", location:"For√™t de Cumberland", condition:"En journ√©e dans le brouillard" },
  { id:"wapiti_ozula", name:"Wapiti Ozula", location:"Cholla Springs", condition:"Au cr√©puscule et de nuit dans le brouillard" },
  { id:"wapiti_inahme", name:"Wapiti Inahme", location:"Gorge de l‚ÄôAraign√©e", condition:"Mission" },
  { id:"renard_croise", name:"Renard crois√©", location:"Bayou Nwa", condition:"Mission" },
  { id:"renard_marbre", name:"Renard marbr√©", location:"Colter", condition:"√Ä l‚Äôaube ou au cr√©puscule par temps clair" },
  { id:"renard_ota", name:"Renard Ota", location:"Ouest de Rhodes", condition:"√Ä l‚Äôaube ou au cr√©puscule par temps clair" },
  { id:"alligator_dore", name:"Alligator dor√©", location:"Marais de Lagras (au nord de Saint Denis)", condition:"√Ä l‚Äôaube dans le brouillard" },
  { id:"alligator_teca", name:"Alligator Teca", location:"Rivi√®re Lannahechee (au sud de Saint Denis)", condition:"De nuit par temps orageux" },
  { id:"alligator_bandes", name:"Alligator √† bandes", location:"Saint Denis", condition:"Mission" },
  { id:"orignal_flocon", name:"Orignal flocon de neige", location:"Lagune Barrow", condition:"De nuit sous la pluie" },
  { id:"orignal_roux", name:"Orignal roux", location:"Tall Trees", condition:"Mission" },
  { id:"orignal_chevalier", name:"Orignal chevalier", location:"Nord de la rivi√®re Kamassa", condition:"En journ√©e" },
  { id:"panthere_noctivague", name:"Panth√®re noctivague", location:"Bolger Glade", condition:"Au cr√©puscule dans le brouillard" },
  { id:"panthere_fantome", name:"Panth√®re fant√¥me", location:"Merkins Waller et Macomb‚Äôs", condition:"De nuit sous la pluie" },
  { id:"panthere_iwakta", name:"Panth√®re Iwakta", location:"Pr√®s du manoir Braithwaite", condition:"Mission" },
  { id:"mouflon_craie", name:"Mouflon corne craie", location:"Sud de Cottora Springs", condition:"En journ√©e par temps clair" },
  { id:"mouflon_gabbro", name:"Mouflon corne gabbro", location:"Rio Bravo", condition:"√Ä l‚Äôaube et en journ√©e par temps clair" },
  { id:"mouflon_rutile", name:"Mouflon corne rutile", location:"Rio Bravo et Cholla Springs", condition:"Mission" },
  { id:"loup_emeraude", name:"Loup √©meraude", location:"O‚ÄôCreagh‚Äôs Run", condition:"De nuit" },
  { id:"loup_onyx", name:"Loup d‚Äôonyx", location:"Sud du ravin Calumet et Cottora Springs", condition:"De nuit par temps clair" },
  { id:"loup_pierre_de_lune", name:"Loup pierre de lune", location:"Nord de la for√™t de Cumberland", condition:"Mission" }
];

/* ===== Noms FR affich√©s ===== */
const NAME_OVERRIDE = {
  /* Sombres */ alligator_teca:"Alligator Teca l√©gendaire", castor_tenebreux:"Castor t√©n√©breux l√©gendaire", bison_tatanka:"Bison Tatanka l√©gendaire", cerf_ombre:"Cerf ombr√© l√©gendaire", couguar_sapa:"Couguar Sapa l√©gendaire", coyote_ebene:"Coyote d'√©b√®ne l√©gendaire", wapiti_katata:"Wapiti Katata l√©gendaire", loup_onyx:"Loup d'onyx l√©gendaire", panthere_noctivague:"Panth√®re noctivague l√©gendaire", mouflon_rutile:"Mouflon √† cornes de rutile l√©gendaire", orignal_chevalier:"Orignal chevalier l√©gendaire",
  /* Clairs */ castor_lunaire:"Castor s√©l√®ne l√©gendaire", bison_winyan:"Bison Winyan l√©gendaire", cerf_des_neiges:"Cerf des neiges l√©gendaire", couguar_iguga:"Couguar Iguga l√©gendaire", coyote_laiteux:"Coyote laiteux l√©gendaire", wapiti_inahme:"Wapiti Inahme l√©gendaire", loup_pierre_de_lune:"Loup de pierre de lune l√©gendaire", panthere_fantome:"Panth√®re fant√¥me l√©gendaire", mouflon_gabbro:"Mouflon √† cornes de gabbro l√©gendaire", orignal_flocon:"Orignal neigeux l√©gendaire",
  /* Roux ou sable */ alligator_dore:"Alligator dor√© l√©gendaire", alligator_bandes:"Alligator √† bandes l√©gendaire", bison_payta:"Bison Payta l√©gendaire", sanglier_wakpa:"Sanglier Wakpa l√©gendaire", coyote_rubigineux:"Coyote rubigineux l√©gendaire", wapiti_ozula:"Wapiti Ozula l√©gendaire", loup_emeraude:"Loup d'√©meraude l√©gendaire", ours_esprit_cotier:"Ours esprit √† rayure dorsale l√©gendaire", ours_esprit_dore:"Ours esprit dor√© l√©gendaire", castor_zizi:"Castor solaire l√©gendaire", sanglier_cogi:"Sanglier Cogi l√©gendaire", orignal_roux:"Orignal √† bois rouge√¢tres l√©gendaire",
  /* Tachet√©s/Ray√©s */ ours_owiza:"Ours Owiza l√©gendaire", sanglier_icahi:"Sanglier Icahi l√©gendaire", cerf_pataugeur:"Cerf pataugeur l√©gendaire", couguar_maza:"Couguar Maza l√©gendaire", renard_ota:"Renard Ota l√©gendaire", renard_marbre:"Renard marbr√© l√©gendaire", renard_croise:"Renard crois√© l√©gendaire", panthere_iwakta:"Panth√®re Iwakta l√©gendaire", mouflon_craie:"Mouflon √† cornes de craie l√©gendaire"
};

/* ===== Cat√©gories (cl√© = nom de dossier) ===== */
const CATEGORIES = [
  { key: "dark",      title: "Sombres",        items: ["alligator_teca","castor_tenebreux","bison_tatanka","cerf_ombre","couguar_sapa","coyote_ebene","wapiti_katata","loup_onyx","panthere_noctivague","mouflon_rutile","orignal_chevalier"] },
  { key: "light",     title: "Clairs",         items: ["castor_lunaire","bison_winyan","cerf_des_neiges","couguar_iguga","coyote_laiteux","wapiti_inahme","loup_pierre_de_lune","panthere_fantome","mouflon_gabbro","orignal_flocon"] },
  { key: "red_blond", title: "Roux ou sable",  items: ["alligator_dore","alligator_bandes","bison_payta","sanglier_wakpa","coyote_rubigineux","wapiti_ozula","loup_emeraude","ours_esprit_cotier","ours_esprit_dore","castor_zizi","sanglier_cogi","orignal_roux"] },
  { key: "patterned", title: "Tachet√©s/ray√©s", items: ["ours_owiza","sanglier_icahi","cerf_pataugeur","couguar_maza","renard_ota","renard_marbre","renard_croise","panthere_iwakta","mouflon_craie"] }
];

/* ===== Mapping ID -> fichier image (dans dossier cat) ===== */
const IMAGE_MAP = {
  /* dark */ alligator_teca:"legendary_teca_gator.png", castor_tenebreux:"legendary_night_beaver.png", bison_tatanka:"legendary_tatanka_bison.png", cerf_ombre:"legendary_shadow_buck.png", couguar_sapa:"legendary_sapa_cougar.png", coyote_ebene:"legendary_midnight_paw_coyote.png", wapiti_katata:"legendary_katata_elk.png", loup_onyx:"legendary_onyx_wolf.png", panthere_noctivague:"legendary_nightwalker_panther.png", mouflon_rutile:"legendary_rutile_horn_ram.png", orignal_chevalier:"legendary_knight_moose.png",
  /* light */ mouflon_gabbro:"legendary_gabbro_horn_ram.png", panthere_fantome:"legendary_ghost_panther.png", couguar_iguga:"legendary_iguga_cougar.png", wapiti_inahme:"legendary_inahme_elk.png", coyote_laiteux:"legendary_milk_coyote.png", loup_pierre_de_lune:"legendary_moonstone_wolf.png", castor_lunaire:"legendary_moon_beaver.png", orignal_flocon:"legendary_snowflake_moose.png", cerf_des_neiges:"legendary_snow_buck.png", bison_winyan:"legendary_winyan_bison.png",
  /* patterned */ mouflon_craie:"legendary_chalk_horn_ram.png", renard_croise:"legendary_cross_fox.png", sanglier_icahi:"legendary_icahi_boar.png", panthere_iwakta:"legendary_iwakta_panther.png", renard_marbre:"legendary_marble_fox.png", couguar_maza:"legendary_maza_cougar.png", cerf_pataugeur:"legendary_mud_runner_buck.png", renard_ota:"legendary_ota_fox.png", ours_owiza:"legendary_owiza_bear.png",
  /* red_blond */ alligator_bandes:"legendary_banded_gator.png", sanglier_cogi:"legendary_cogi_boar.png", loup_emeraude:"legendary_emerald_wolf.png", ours_esprit_dore:"legendary_golden_spirit_bear.png", wapiti_ozula:"legendary_ozula_elk.png", bison_payta:"legendary_payta_bison.png", coyote_rubigineux:"legendary_red_streak_coyote.png", ours_esprit_cotier:"legendary_ridgeback_spirit_bear.png", orignal_roux:"legendary_ruddy_moose.png", alligator_dore:"legendary_sun_gator.png", sanglier_wakpa:"legendary_wapka_boar.png", castor_zizi:"legendary_zizi_beaver.png"
};

/* ===== Theme ===== */
function applyTheme(t){ document.documentElement.setAttribute("data-theme", t); localStorage.setItem(KEYS.theme,t); }
(function initTheme(){
  const saved = localStorage.getItem(KEYS.theme);
  applyTheme(saved || "dark");
})();
document.getElementById("themeBtn").addEventListener("click", ()=>{
  const cur = document.documentElement.getAttribute("data-theme");
  applyTheme(cur === "dark" ? "light" : "dark");
});

/* ===== Helpers ===== */
const groupsEl = document.getElementById('groups');
const gFill = document.getElementById('gFill');
const gPct  = document.getElementById('gPct');
const gCount= document.getElementById('gCount');
const q = document.getElementById('q');
const fMission = document.getElementById('fMission');
const fTag = document.getElementById('fTag');
const filtersPanel = document.getElementById('filtersPanel');
const filtersToggleBtn = document.getElementById('filtersToggle');

const baseById = Object.fromEntries(BASE.map((a,i)=>[a.id,{...a, idx:i}]));
const isOn = key => localStorage.getItem(key)==="true";
const setOn = (key,val)=> localStorage.setItem(key, val ? "true" : "false");
const rowCount = i => ACTIONS.reduce((n,a)=> n + (isOn(KEYS.action(i,a.key))?1:0), 0);
const missionFlag = cond => /mission/i.test(cond) ? 'mission' : 'libre';
function tagSet(cond){
  const s = cond.toLowerCase();
  return { aube:/aube/.test(s), crepuscule:/cr√©puscule|crepuscule/.test(s), nuit:/nuit/.test(s),
    journee:/journ√©e|journee/.test(s), pluie:/pluie/.test(s), brouillard:/brouillard/.test(s),
    orage:/orage/.test(s), clair:/clair/.test(s) };
}
const ANIMALS_BY_IDX = BASE.map((b)=>{
  const display = NAME_OVERRIDE[b.id] || (b.name + " l√©gendaire");
  return { ...b, displayName: display, mission: missionFlag(b.condition), tags: tagSet(b.condition) };
});

/* ===== Filtres panel state ===== */
const isDesktop = () => window.matchMedia("(min-width: 780px)").matches;
const savedOpen = localStorage.getItem(KEYS.filtersOpen);
filtersPanel.open = savedOpen ? savedOpen === "true" : isDesktop();
filtersPanel.addEventListener('toggle', ()=> localStorage.setItem(KEYS.filtersOpen, String(filtersPanel.open)) );
filtersToggleBtn.addEventListener('click', ()=>{
  filtersPanel.open = !filtersPanel.open;
  localStorage.setItem(KEYS.filtersOpen, String(filtersPanel.open));
});

/* ===== Render ===== */
function render(){
  groupsEl.innerHTML = "";

  CATEGORIES.forEach(cat=>{
    // SECTION card
    const section = document.createElement('details');
    section.className = "section-card";
    section.dataset.cat = cat.key;

    const secOpenKey = KEYS.sectionOpen(cat.key);
    const secSaved = localStorage.getItem(secOpenKey);
    section.open = secSaved ? secSaved === "true" : true;

    const summary = document.createElement('summary');
    summary.innerHTML = `
      <span class="cat-dot"></span> ${cat.title}
      <div class="cat-meta">
        <span class="cat-pct" data-cat-pct="${cat.key}">0%</span>
        <div class="cat-bar"><div class="cat-fill warn" data-cat-fill="${cat.key}"></div></div>
      </div>`;
    section.appendChild(summary);

    const body = document.createElement('div');
    body.className = "section-body";
    const cardsGrid = document.createElement('div');
    cardsGrid.className = "cards-grid";
    body.appendChild(cardsGrid);
    section.appendChild(body);

    // cards in the exact order provided
    cat.items.forEach(id=>{
      const b = baseById[id]; if(!b) return;
      const a = ANIMALS_BY_IDX[b.idx];
      const display = NAME_OVERRIDE[id] || a.displayName;

      const imgFile = IMAGE_MAP[id];
      const imgSrc = imgFile ? `img/${cat.key}/${imgFile}` : "";

      const card = document.createElement('article');
      card.className = "card";
      card.dataset.index = b.idx;
      card.dataset.mission = a.mission;
      card.dataset.tags = JSON.stringify(a.tags);
      card.innerHTML = `
        <div class="top">
          ${imgSrc ? `<div class="thumb"><img src="${imgSrc}" alt="${display}" loading="lazy" decoding="async"></div>` : `<div class="thumb"></div>`}
          <div class="info">
            <div class="name">${display}</div>
            <div class="loc">üìç ${a.location}</div>
            <div class="cond">üß≠ ${a.condition}</div>
          </div>
        </div>

        <div class="rowbar">
          <div class="pct" data-pct>0%</div>
          <div class="bar" style="flex:1"><div class="fill warn" data-fill style="width:0%"></div></div>
          <div class="count" data-count>0/${ACTIONS.length}</div>
        </div>

        <div class="checklist" role="group" aria-label="Checklist ${display}">
          ${ACTIONS.map(ac=>{
            const key=KEYS.action(b.idx,ac.key), on=isOn(key);
            return `<button class="tick" data-key="${key}" data-on="${on}" title="${ac.key}">${ac.icon}</button>`;
          }).join('')}
        </div>
      `;
      cardsGrid.appendChild(card);
      updateRow(b.idx, card);
    });

    section.addEventListener('toggle', ()=>{
      localStorage.setItem(secOpenKey, String(section.open));
    });

    groupsEl.appendChild(section);
  });

  // bind ticks
  groupsEl.querySelectorAll('.tick').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const key = btn.dataset.key;
      const now = btn.getAttribute('data-on') !== "true";
      btn.setAttribute('data-on', String(now));
      setOn(key, now);
      const idx = key.replace(PREFIX,"").split(':')[0];
      const card = groupsEl.querySelector(`.card[data-index="${idx}"]`);
      updateRow(idx, card);
      updateGlobal();
      updateAllCategories();
    }, {passive:true});
  });

  applyFilters();
  updateGlobal();
  updateAllCategories();
}

function updateRow(i, cardEl){
  const card = cardEl || groupsEl.querySelector(`.card[data-index="${i}"]`);
  if(!card) return;
  const done = rowCount(i);
  const pct  = Math.round(done / ACTIONS.length * 100);
  const fill = card.querySelector('[data-fill]');
  fill.style.width = pct + "%";
  fill.classList.toggle('ok', pct>=50);
  fill.classList.toggle('warn', pct<50);
  card.querySelector('[data-pct]').textContent = pct + "%";
  card.querySelector('[data-count]').textContent = `${done}/${ACTIONS.length}`;
}

function updateGlobal(){
  const total = ANIMALS_BY_IDX.length * ACTIONS.length;
  let checked = 0;
  ANIMALS_BY_IDX.forEach((_,i)=> checked += rowCount(i));
  const pct = total ? Math.round(checked/total*100) : 0;
  gFill.style.width = pct + "%";
  gFill.classList.toggle('ok', pct>=50);
  gFill.classList.toggle('warn', pct<50);
  gPct.textContent = pct + "%";
  gCount.textContent = `${checked} / ${total} actions`;
}

/* ---- Category progress (title line) ---- */
function categoryIndices(catKey){
  const cat = CATEGORIES.find(c => c.key === catKey);
  if(!cat) return [];
  return cat.items.map(id => baseById[id]?.idx).filter(i => Number.isInteger(i));
}
function updateCategory(catKey){
  const idxs = categoryIndices(catKey);
  const total = idxs.length * ACTIONS.length;
  let checked = 0;
  idxs.forEach(i => checked += rowCount(i));
  const pct = total ? Math.round(checked/total*100) : 0;

  const pctEl = document.querySelector(`[data-cat-pct="${catKey}"]`);
  const fillEl = document.querySelector(`[data-cat-fill="${catKey}"]`);
  if(pctEl){ pctEl.textContent = pct + "%"; }
  if(fillEl){
    fillEl.style.width = pct + "%";
    fillEl.classList.toggle('ok', pct>=50);
    fillEl.classList.toggle('warn', pct<50);
  }
}
function updateAllCategories(){
  CATEGORIES.forEach(c => updateCategory(c.key));
}

/* ===== Filtres & recherche ===== */
function applyFilters(){
  const text = q.value.trim().toLowerCase();
  const missionVal = fMission ? fMission.value : "";
  const tagVal = fTag ? fTag.value : "";

  groupsEl.querySelectorAll('.card').forEach(card=>{
    const i = +card.dataset.index;
    const a = ANIMALS_BY_IDX[i];
    let visible = true;

    if (text){
      const hay = `${a.displayName} ${a.location} ${a.condition}`.toLowerCase();
      visible = hay.includes(text);
    }
    if (visible && missionVal) visible = card.dataset.mission === missionVal;
    if (visible && tagVal){
      const tags = JSON.parse(card.dataset.tags);
      visible = !!tags[tagVal];
    }
    card.style.display = visible ? "" : "none";
  });

  // hide section if empty after filters
  groupsEl.querySelectorAll('.section-card').forEach(sec=>{
    const anyVisible = Array.from(sec.querySelectorAll('.card')).some(c => c.style.display !== 'none');
    sec.style.display = anyVisible ? "" : "none";
  });
}

q.addEventListener('input', applyFilters, {passive:true});
if (fMission) fMission.addEventListener('change', applyFilters);
if (fTag) fTag.addEventListener('change', applyFilters);

/* ===== Bulk & chips ===== */
document.getElementById('checkAll').addEventListener('click', ()=>{
  groupsEl.querySelectorAll('.card').forEach(card=>{
    if(card.style.display==="none") return;
    const idx = card.dataset.index;
    ACTIONS.forEach(a=>{
      const k = KEYS.action(idx,a.key);
      if(!isOn(k)) setOn(k,true);
      const b = card.querySelector(`.tick[data-key="${k}"]`);
      if(b) b.setAttribute('data-on','true');
    });
    updateRow(idx, card);
  });
  updateGlobal();
  updateAllCategories();
});
document.getElementById('uncheckAll').addEventListener('click', ()=>{
  groupsEl.querySelectorAll('.card').forEach(card=>{
    if(card.style.display==="none") return;
    const idx = card.dataset.index;
    ACTIONS.forEach(a=>{
      const k = KEYS.action(idx,a.key);
      if(isOn(k)) setOn(k,false);
      const b = card.querySelector(`.tick[data-key="${k}"]`);
      if(b) b.setAttribute('data-on','false');
    });
    updateRow(idx, card);
  });
  updateGlobal();
  updateAllCategories();
});
document.getElementById('resetAll').addEventListener('click', ()=>{
  ANIMALS_BY_IDX.forEach((_,i)=> ACTIONS.forEach(a=> localStorage.removeItem(KEYS.action(i,a.key))));
  render();
});

// Chips = toggle action pour cartes visibles
document.querySelectorAll('[data-action-chip]').forEach(chip=>{
  chip.addEventListener('click', ()=>{
    const actionKey = chip.getAttribute('data-action-chip');
    const visibleCards = Array.from(groupsEl.querySelectorAll('.card')).filter(c=> c.style.display !== "none");
    let onCount = 0;
    visibleCards.forEach(card=>{
      const idx = card.dataset.index;
      if (localStorage.getItem(KEYS.action(idx,actionKey)) === "true") onCount++;
    });
    const turnOn = onCount / Math.max(visibleCards.length,1) < 0.5;
    visibleCards.forEach(card=>{
      const idx = card.dataset.index;
      const key = KEYS.action(idx,actionKey);
      localStorage.setItem(key, String(turnOn));
      const btn = card.querySelector(`.tick[data-key="${key}"]`);
      if (btn) btn.setAttribute('data-on', String(turnOn));
      updateRow(idx, card);
    });
    updateGlobal();
    updateAllCategories();
  }, {passive:true});
});

/* ===== Clear storage (prefix only) ===== */
document.getElementById('clearLS').addEventListener('click', ()=>{
  if (confirm("Effacer TOUTES les donn√©es TBVS_RDO_ (th√®me, progression, filtres, sections) ?")) {
    Object.keys(localStorage).forEach(k=>{
      if (k.startsWith(PREFIX)) localStorage.removeItem(k);
    });
    location.reload();
  }
});

/* ===== iPhone: emp√™cher le double-tap zoom sur les ticks ===== */
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.tick').forEach(t => {
    t.addEventListener('touchstart', e => {
      e.preventDefault();
      t.click();
    }, { passive: false });
  });
});

/* ===== Init ===== */
render();
</script>
</body>
</html>
